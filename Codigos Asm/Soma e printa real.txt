section .data
M:
resb 10000h; 0
dd 12.5; 10000h
dd 3.5; 10004h
db "vazia"
resb 250
section .text
global _start
_start:



movss xmm0, [qword M+10000h] ;real a ser
movss xmm1, [qword M+10004h]
addss xmm0, xmm1
movss [qword M+10000h], xmm0  ;real a ser
movss xmm0, [qword M+10000h] ;real a ser


mov rsi, M ;end. temporário
mov rcx, 0 ;contador pilha
mov rdi, 6 ;precisao 6 casas compart
mov rbx, 10 ;divisor
cvtsi2ss xmm2, rbx ;divisor real
subss xmm1, xmm1 ;zera registrador
comiss xmm0, xmm1 ;verifica sinal
jae Rot0 ;salta se número positivo
mov dl, '-' ;senão, escreve sinal –
mov [rsi], dl
mov rdx, -1 ;Carrega -1 em RDX
cvtsi2ss xmm1, rdx ;Converte para real
mulss xmm0, xmm1 ;Toma módulo
add rsi, 1 ;incrementa índice
Rot0:
roundss xmm1, xmm0, 0b0011 ;parte inteira xmm1
subss xmm0, xmm1 ;parte frac xmm0
cvtss2si rax, xmm1 ;convertido para int
;converte parte inteira que está em rax
Rot1:
add rcx, 1 ;incrementa contador
cdq ;estende edx:eax p/ div.
idiv ebx ;divide edx;eax por ebx
push dx ;empilha valor do resto
cmp eax, 0 ;verifica se quoc. é 0
jne Rot1 ;se não é 0, continua
sub rdi, rcx ;decrementa precisao
;agora, desemp valores e escreve parte int
Rot2:
pop dx ;desempilha valor
add dl, '0' ;transforma em caractere
mov [rsi], dl ;escreve caractere
add rsi, 1 ;incrementa base
sub rcx, 1 ;decrementa contador
cmp rcx, 0 ;verifica pilha vazia
jne Rot2 ;se não pilha vazia, loop
mov dl, '.' ;escreve ponto decimal
mov [rsi], dl
add rsi, 1 ;incrementa base
;converte parte fracionaria que está em xmm0
Rot3:
cmp rdi, 0 ;verifica precisao
jle Rot4 ;terminou precisao ?
mulss xmm0,xmm2 ;desloca para esquerda
roundss xmm1,xmm0,0b0011 ;parte inteira xmm1
subss xmm0,xmm1 ;atualiza xmm0
cvtss2si rdx, xmm1 ;convertido para int
add dl, '0' ;transforma em caractere
mov [rsi], dl ;escreve caractere
add rsi, 1 ;incrementa base
sub rdi, 1 ;decrementa precisao
jmp Rot3
; impressão
Rot4:
mov dl, 0 ;fim string, opcional
mov [rsi], dl ;escreve caractere
mov rdx, rsi ;calc tam str convertido
mov rbx, M
sub rdx, rbx ;tam=rsi-M-buffer.end
mov rsi, M; endereço do buffer


; Interrupção de saida
mov rax, 1 ;chamada para saída
mov rdi, 1 ;saída para tela
syscall

mov rax, 60
mov rdi, 0
syscall
